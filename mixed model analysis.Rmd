---
title: "Mixed Model Analysis of Individual Effects"
output: html_notebook
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
source('lib.R')
data.raw <- load.data.exp1()
df.simon <- clean.simon()
df.flanker <- clean.flanker()
df.stroop <- clean.stroop()
```

# Experiment 1
##Create Linear Mixed Model for each task
```{r}
library(lme4)

model.simon <- lme4::lmer(scale(RT) ~ prevcon*Congruency + (1+prevcon*Congruency|Subject), data = df.simon)
model.stroop <- lme4::lmer(scale(RT) ~ prevcon*Congruency + (1+prevcon*Congruency|Subject), data = df.stroop)
model.flanker <- lme4::lmer(scale(RT) ~ prevcon*Congruency + (1+prevcon*Congruency|Subject), data = df.flanker)

```

##Get point estimates and 'prediction intervals' for each random effect in model
```{r}
Randomeffect.CIs <- function(model, factor){
  conf.congruency <- 
    cbind(ranef(model, condVar = T)$Subject[[factor]],
    ranef(model, condVar = T)$Subject[[factor]]+
      (-1*qnorm(.975)*sqrt(attr(ranef(model, condVar = TRUE)[[1]], "postVar")
                           [factor,factor,])),
    ranef(model, condVar = T)$Subject[[factor]]+
      (1*qnorm(.975)*sqrt(attr(ranef(model, condVar = TRUE)[[1]], "postVar")
                          [factor,factor,])))
                           
}

simon.congruency <- as.data.frame(Randomeffect.CIs(model.simon, 2)) %>% 
  arrange(V1) %>% mutate(order = rep(1:178), bestmodel = (ifelse((V3 < 0 | V2 > 0),1,0)))

library(ggplot2)
ggplot(simon.congruency, 
       aes(x = order, y = V1, color = factor(bestmodel))) +
  geom_point() +
  geom_errorbar(aes(ymin=V2, ymax=V3), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Simon Random Effect Estimate for Congruency") +
  geom_hline(yintercept=0) +
  theme_classic()

```

```{r}
#plot stuff
ggplot(plot.CI.simon.congruency, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Simon Random Effect Estimate for Congruency") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.flanker.congruency, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Flanker Random Effect Estimate for Congruency") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.stroop.congruency, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Stroop Random Effect Estimate for Congruency") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.simon.prevcon, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Simon Random Effect Estimate for PrevCon") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.flanker.prevcon, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Flanker Random Effect Estimate for PrevCon") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.stroop.prevcon, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Stroop Random Effect Estimate for PrevCon") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.simon.int, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Simon Random Effect Estimate for Interaction") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.flanker.int, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Flanker Random Effect Estimate for Interaction") +
  geom_hline(yintercept=0) +
  theme_classic()

ggplot(plot.CI.stroop.int, 
       aes(x = order, y = point, color = bestmodel)) +
  geom_point() +
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.2) +
  scale_color_brewer(palette = "Set1") +
  xlab("Subject") + ylab("Stroop Random Effect Estimate for Interaction") +
  geom_hline(yintercept=0) +
  theme_classic()
```

